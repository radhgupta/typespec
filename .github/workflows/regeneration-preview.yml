name: C# Generator - Regeneration Preview

on:
  workflow_dispatch:
    inputs:
      generator_filter:
        description: 'Which generator type to regenerate'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - azure
        - unbranded
        - mgmt

permissions:
  contents: read
  pull-requests: write

jobs:
  regenerate-preview:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      # Step 1: Checkout TypeSpec repository (where generators are)
      - name: Checkout TypeSpec Repository
        uses: actions/checkout@v4
        with:
          path: typespec
          
      # Step 2: Checkout Azure SDK repository (target for regeneration)
      - name: Checkout Azure SDK Repository  
        uses: actions/checkout@v4
        with:
          repository: Azure/azure-sdk-for-net
          path: azure-sdk-for-net
          token: ${{ secrets.GITHUB_TOKEN }}
          
      # Step 3: Setup .NET SDK
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0'
      
      # Step 4: Setup Node.js  
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          
      # Step 5: Setup PowerShell (ensure pwsh is available)
      - name: Setup PowerShell
        run: |
          # PowerShell should already be available on ubuntu-latest
          pwsh --version
          
      # Step 6: Install TypeSpec dependencies and build generators
      - name: Install Dependencies and Build Generators
        working-directory: typespec/packages/http-client-csharp
        run: |
          npm ci
          npm run build
          
      # Step 7: Run Regeneration Preview Script
      - name: Run Regeneration Preview
        working-directory: typespec/packages/http-client-csharp
        shell: pwsh
        run: |
          $params = @{
            SdkLibraryRepoPath = "${{ github.workspace }}/azure-sdk-for-net"
          }
          
          # Add generator filter based on user input
          switch ("${{ inputs.generator_filter }}") {
            "azure" { $params.Azure = $true }
            "unbranded" { $params.Unbranded = $true }
            "mgmt" { $params.Mgmt = $true }
            "all" { 
              Write-Host "Regenerating all generator types"
              # No filter means all generators
            }
          }
          
          Write-Host "Running regeneration with filter: ${{ inputs.generator_filter }}"
          ./eng/scripts/RegenPreview.ps1 @params
          
      # Step 8: Create Draft PR in Azure SDK repository
      - name: Create Draft PR with Generated Changes
        if: success()
        uses: peter-evans/create-pull-request@v5
        with:
          path: azure-sdk-for-net
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            [Automated] Regeneration preview from TypeSpec changes
            
            Generator filter: ${{ inputs.generator_filter }}
            TypeSpec commit: ${{ github.sha }}
            Triggered by: @${{ github.actor }}
          
          branch: regen-preview/${{ github.run_number }}
          title: |
            [PREVIEW] C# Generator Changes - ${{ inputs.generator_filter }} (${{ github.run_number }})
          
          body: |
            ## üîÑ Regeneration Preview from TypeSpec Changes
            
            This is an **automated preview** of code generation changes from the TypeSpec repository.
            
            ### Details
            - **Generator filter**: `${{ inputs.generator_filter }}`
            - **Source TypeSpec commit**: ${{ github.sha }}
            - **Triggered by**: @${{ github.actor }}
            - **Run number**: ${{ github.run_number }}
            - **TypeSpec PR**: [View source changes](https://github.com/microsoft/typespec/compare/main...${{ github.sha }})
            
            ### What to review
            üìã **Check the file changes below** to understand the impact of the TypeSpec generator changes on Azure SDK libraries.
            
            ### Important Notes
            ‚ö†Ô∏è **This PR should NOT be merged** - it's for review purposes only.
            üßπ This PR will be automatically closed/deleted after review.
            üîÑ Re-run the workflow to generate a fresh preview if needed.
            
            ---
            *Generated by [TypeSpec Regeneration Preview Workflow](https://github.com/microsoft/typespec/actions)*
          
          draft: true
          delete-branch: false
          
      # Step 9: Report Results
      - name: Report Workflow Results
        if: always()
        shell: pwsh
        run: |
          $status = "${{ job.status }}"
          $filter = "${{ inputs.generator_filter }}"
          
          Write-Host "============================================"
          Write-Host "  C# Generator Regeneration Preview Results"
          Write-Host "============================================"
          Write-Host "Generator Filter: $filter"
          Write-Host "Workflow Status: $status"
          Write-Host "TypeSpec Commit: ${{ github.sha }}"
          Write-Host ""
          
          if ($status -eq 'success') {
            Write-Host "‚úÖ SUCCESS: Regeneration preview completed!"
            Write-Host "üìù Draft PR created in Azure SDK repository"
            Write-Host "üîó Check the Actions summary for PR link"
          } elseif ($status -eq 'failure') {
            Write-Host "‚ùå FAILURE: Regeneration preview failed"
            Write-Host "üîç Check the workflow logs above for details"
            Write-Host "üí° Common issues:"
            Write-Host "   - Build failures in generators"
            Write-Host "   - PowerShell script errors"
            Write-Host "   - Network/permission issues"
          } else {
            Write-Host "‚ö†Ô∏è  CANCELLED: Workflow was cancelled"
          }
          
          Write-Host ""
          Write-Host "============================================"


